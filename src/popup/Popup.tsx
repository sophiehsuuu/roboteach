import { useState, useEffect } from "react";
declare const chrome: any;

// --- Strict keys for error types ---
type ErrorTypeKey = "" | "motor" | "direction" | "not-starting" | "stop" | "sensor" | "other";

// --- Styles ---
const fontsBase = {
  fontFamily: `'Poppins', 'Noto Sans TC', 'Microsoft JhengHei', Arial, Helvetica, sans-serif`
};
const headingStyle = {
  ...fontsBase, color: "#2C3E50", fontWeight: 700, fontSize: 20, margin: "8px 0 2px 0", lineHeight: "1.2"
};
const subheadingStyle = {
  ...fontsBase, color: "#2C3E50", fontWeight: 500, fontSize: 15, marginBottom: 6, letterSpacing: 0.5
};
const areaStyle = {
  background: "#F5F5F5", borderRadius: "10px", padding: "8px", border: "1px solid #E0E0E0", marginBottom: 8,
  fontSize: 14, color: "#2C3E50", width: "100%"
};
const secondaryBtn = {
  background: "#92BDE7", color: "#2C3E50", border: "none",
  padding: "9px 18px", borderRadius: 6, fontWeight: 600,
  fontFamily: "Poppins, Arial, sans-serif", cursor: "pointer",
  fontSize: 16, marginTop: 8, marginBottom: 5
};
const infoMsg = { color: "#FFD54F", fontWeight: 400, margin: "6px 0" };
const normalMsg = { color: "#2C3E50", fontWeight: 400, margin: "6px 0" };

const errorAdviceMap: Record<Exclude<ErrorTypeKey, "">, {
  zh: string;
  en: string;
  generic: { zhTips: string; enTips: string; };
}> = {
  "motor": {
    zh: "È¶¨ÈÅîÊú™ÂïüÂãï",
    en: "Motor Not Moving",
    generic: {
      zhTips: "Ë´ãÊ™¢Êü•È¶¨ÈÅîÁ©çÊú®ÊòØÂê¶ÈÄ£Êé•‰∏îË®≠ÂÆöÂïüÂãïÂãï‰Ωú„ÄÇ\nÁ¢∫‰øùÁ´ØÂè£ÂåπÈÖçËàáÈÄ£Á∑öÊ≠£Â∏∏ÔºåÊàñÊèõÈõªÊ±†„ÄÇ",
      enTips: "Check if motor blocks are connected & set to start. Ensure matching ports and connections, or try fresh batteries."
    }
  },
  "direction": {
    zh: "Ê©üÂô®‰∫∫ÊñπÂêëÈåØË™§",
    en: "Robot Moving Wrong Direction",
    generic: {
      zhTips: "Ê™¢Êü•Â∑¶Âè≥È¶¨ÈÅîË®≠ÂÆöÂèäÈ†Ü/ÈÄÜÊôÇÈáù„ÄÇÁ¢∫Ë™çÊúâÁÑ°Ë®≠ÂÆöÈåØË™§ÁöÑÊñπÂêëÁ©çÊú®„ÄÇ",
      enTips: "Check left/right motors and clockwise/counterclockwise. Confirm there are no wrong direction blocks."
    }
  },
  "not-starting": {
    zh: "Á®ãÂºèÊú™ÈñãÂßã",
    en: "Code Not Starting",
    generic: {
      zhTips: "Ë´ãÁ¢∫Ë™çÊúâ„ÄéÈñãÂßã„ÄèÁ©çÊú®Ôºå‰∏¶ÈªûÈÅ∏Âü∑Ë°å„ÄÇ",
      enTips: "Make sure you have a 'start' block and click run."
    }
  },
  "stop": {
    zh: "ÁÑ°Ê≥ïÂÅúÊ≠¢",
    en: "Can't Stop",
    generic: {
      zhTips: "Ê™¢Êü•ÊúâÁÑ°„ÄéÂÅúÊ≠¢„ÄèÁ©çÊú®„ÄÇÁ¢∫Ë™çÊúâÊ©üÊúÉË∑≥Âá∫Âæ™Áí∞„ÄÇ",
      enTips: "Check for stop blocks. Make sure all loops can be exited."
    }
  },
  "sensor": {
    zh: "ÊÑüÊáâÂô®ÁÑ°ÂèçÊáâ",
    en: "Sensor Not Responding",
    generic: {
      zhTips: "Ê™¢Êü•ÊÑüÊáâÂô®Á©çÊú®ÊòØÂê¶Ë®≠ÂÆöÊ≠£Á¢∫‰∏¶Â∑≤ÊèíÂÖ•„ÄÇ",
      enTips: "Check sensor blocks are set and sensor is plugged in."
    }
  },
  "other": {
    zh: "ÂÖ∂‰ªñÔºèÊú™ÂàóÂá∫ÂïèÈ°å",
    en: "Other / Not Listed",
    generic: {
      zhTips: "Ë´ãÁ∞°Ë¶ÅÊèèËø∞ÂïèÈ°åÂæåÔºå‰ΩøÁî®‰∏ãÊñπ AI ÂçîÂä©ÂäüËÉΩ„ÄÇ",
      enTips: "Describe your issue, then use 'Ask AI' below."
    }
  }
};

const dropdownOptions: { key: ErrorTypeKey; label: string }[] = [
  { key: "", label: "üëá Ë´ãÈÅ∏ÊìáÈÅáÂà∞ÁöÑÂïèÈ°å Select an issue" },
  { key: "motor", label: "È¶¨ÈÅîÊú™ÂïüÂãï / Motor Not Moving" },
  { key: "direction", label: "Ê©üÂô®‰∫∫ÊñπÂêëÈåØË™§ / Wrong Direction" },
  { key: "not-starting", label: "Á®ãÂºèÊú™ÈñãÂßã / Code Not Starting" },
  { key: "stop", label: "ÁÑ°Ê≥ïÂÅúÊ≠¢ / Can't Stop" },
  { key: "sensor", label: "ÊÑüÊáâÂô®ÁÑ°ÂèçÊáâ / Sensor Not Responding" },
  { key: "other", label: "ÂÖ∂‰ªñÔºèÊú™ÂàóÂá∫ÂïèÈ°å / Other" }
];

// --- Smart advice helpers ---
function getCustomMotorAdvice(blocks: any[]) {
  if (!blocks?.length) return "";
  const motorBlocks = blocks.filter(b => b.type && b.type.includes("motor"));
  if (!motorBlocks.length) {
    return "‚ùó ÁõÆÂâçÁ©çÊú®‰∏≠Ê≤íÊúâ‰ªª‰ΩïÈ¶¨ÈÅîÁ©çÊú®„ÄÇ\nNo motor blocks detected.\n";
  }
  let out = "";
  motorBlocks.forEach(b => {
    out += `‚Ä¢ È¶¨ÈÅî${b.MOTOR || b.PORT || ""} ÈÄüÂ∫¶: ${b.SPEED !== undefined ? b.SPEED + "%" : "Êú™Ë®≠ÂÆö"}\n`;
    if (b.SPEED !== undefined && Number(b.SPEED) < 70)
      out += "‚Ü≥ ÈÄüÂ∫¶ÂÅè‰ΩéÔºåÂª∫Ë≠∞ÂòóË©¶Ë®≠ÁÇ∫80%‰ª•‰∏ä„ÄÇ\n(Motor speed is low, recommend setting to 80%+)\n";
    if (!b.MOTOR && !b.PORT)
      out += "‚Ü≥ Êú™ÊåáÂÆöÁ´ØÂè£ÔºåË´ãÈÅ∏ÊìáA/B„ÄÇ\n(No port set, please choose A/B)\n";
  });
  return out;
}
function getCustomDirectionAdvice(blocks: any[]) {
  const motors = blocks.filter(b => b.type && b.type.includes("motor"));
  let advice = "";
  if (motors.length >= 2) {
    const first = motors[0], second = motors[1];
    if (first?.DIRECTION && second?.DIRECTION && first.DIRECTION !== second.DIRECTION)
      advice += "‚ö†Ô∏è ÂÖ©ÂÄãÈ¶¨ÈÅîÊñπÂêëË®≠ÁΩÆ‰∏çÂêåÔºåÂèØËÉΩÈÄ†ÊàêÂéüÂú∞ÊóãËΩâ„ÄÇ\n(Motors set to opposing directions, may rotate in place.)\n";
  }
  return advice;
}
function getCustomNotStartingAdvice(blocks: any[]) {
  if (!blocks || !blocks.length) return "";
  const hasStart = blocks.some(b => b.type && b.type.toLowerCase().includes("start"));
  if (!hasStart) return "‚ùó Ê≤íÊúâÂÅµÊ∏¨Âà∞„ÄéÈñãÂßã„ÄèÁ©çÊú®„ÄÇ\nNo start block detected.\n";
  return "";
}
function getCustomStopAdvice(blocks: any[]) {
  const forever = blocks.filter(b => b.type && b.type.includes("forever"));
  const stops = blocks.filter(b => /stop/i.test(b.type));
  if (forever.length && !stops.length)
    return "‚Ü≥ Á©çÊú®Êúâ„ÄéÊ∞∏ÈÅ†„ÄèÂæ™Áí∞‰ΩÜÊ≤íÊúâÈÅ©ÂêàÁöÑ„ÄéÂÅúÊ≠¢„ÄèÁ©çÊú®„ÄÇ\n(Has forever loop but no stop block.)\n";
  return "";
}
function getCustomSensorAdvice(blocks: any[]) {
  const sensors = blocks.filter(b => b.type && b.type.includes("sensor"));
  if (!sensors.length)
    return "‚ùó Ê≤íÊúâÂÅµÊ∏¨Âà∞‰ªª‰ΩïÊÑüÊáâÂô®Á©çÊú®„ÄÇ\nNo sensor blocks found.\n";
  let out = "";
  sensors.forEach(b => {
    out += `‚Ä¢ ÊÑüÊáâÂô®${b.SENSOR || ""} È°ûÂûã: ${b.type}`;
    if (b.COLOR) out += ` È°èËâ≤ÂÄº: ${b.COLOR}`;
    if (b.VALUE) out += ` ËÆÄÂèñÂÄº: ${b.VALUE}`;
    out += "\n";
  });
  return out;
}

export default function Popup() {
  const [output, setOutput] = useState('');
  const [selectedError, setSelectedError] = useState<ErrorTypeKey>('');
  const [codeSummary, setCodeSummary] = useState('');
  const [loading, setLoading] = useState(false);
  const [blockText, setBlockText] = useState('');
  const [blockData, setBlockData] = useState<any[]>([]);

  useEffect(() => {
    function listener(msg: any) {
      if (msg.type === "SPIKE_BLOCK_STRUCTURED") {
        setBlockData(msg.payload.blocks || []);
        setBlockText(msg.payload.text || "");
      } else if (msg.type === "SPIKE_BLOCK_UPDATE") {
        setBlockText(msg.payload);
      }
    }
    if (typeof chrome !== "undefined" && chrome.runtime && chrome.runtime.onMessage) {
      chrome.runtime.onMessage.addListener(listener);
      return () => chrome.runtime.onMessage.removeListener(listener);
    }
  }, []);

  function handleDropdownChange(e: any) {
    const val = e.target.value as ErrorTypeKey;
    setSelectedError(val);

    let custom = "";
    if (val === "motor") custom = getCustomMotorAdvice(blockData);
    if (val === "direction") custom = getCustomDirectionAdvice(blockData);
    if (val === "not-starting") custom = getCustomNotStartingAdvice(blockData);
    if (val === "stop") custom = getCustomStopAdvice(blockData);
    if (val === "sensor") custom = getCustomSensorAdvice(blockData);

    let zh = "", en = "", zhTips = "", enTips = "";
    if (val && val in errorAdviceMap) {
      const adv = errorAdviceMap[val as keyof typeof errorAdviceMap];
      zh = adv.zh; en = adv.en; zhTips = adv.generic.zhTips; enTips = adv.generic.enTips;
    }

    setOutput(
      `üåü ${zh}\n` +
      (custom ? `„ÄêÂÅµÊ∏¨Ëá™Á®ãÂºè„Äë\n${custom}` : "") +
      `${zhTips}\n\n‚Äî\n` +
      `${en}\n` +
      (custom ? `[From code blocks]\n${custom.replace(/\n/g, " ")}` : "") +
      `${enTips}`
    );
  }

  const handleAskAdvice = async () => {
    setOutput('ÂèñÂæóÂçîÂä©‰∏≠‚Ä¶ Getting advice...');
    setLoading(true);
    const codeData = {
      summary: codeSummary,
      pickedSymptom: selectedError,
      blockText,
      blocks: blockData
    };
    try {
      const resp = await fetch('https://rcwulqsdbrptrrtkluhh.supabase.co/functions/v1/llm-advice', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjd3VscXNkYnJwdHJydGtsdWhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2NjM4NzEsImV4cCI6MjA2OTIzOTg3MX0.ajT317ynsqT0OWwOXroU0GggATbebIRcC5F5nAxVTMg'
        },
        body: JSON.stringify({ code: codeData, lang: 'zh-Hant' }),
      });
      const data = await resp.json();
      setOutput(data.advice || 'No advice returned.');
    } catch (err) {
      setOutput('Error fetching advice. Please try again.');
      console.error(err);
    }
    setLoading(false);
  };

  function renderBlockSummary() {
    if (!blockData?.length) return null;
    return (
      <details style={{
        background: "#F5FAFF", border: "1px solid #BFE6FF", borderRadius: 7, padding: 7, fontSize: 12, marginBottom: 8
      }}>
        <summary style={{ cursor: "pointer", color: "#2293e8", fontWeight: 500, marginBottom: 2 }}>
          üß© Ê™¢Ê∏¨Âà∞ÁöÑÁ©çÊú®Ë®≠ÂÆö (Detected Blocks) {blockData.length > 0 ? `(${blockData.length})` : ""}
        </summary>
        <div style={{ fontFamily: "monospace", whiteSpace: "pre", maxHeight: 80, overflow: "auto" }}>
          {blockData.map((b, i) =>
            `#${i + 1}: ${JSON.stringify(b)}\n`
          )}
        </div>
      </details>
    );
  }

  return (
    <div style={{
      ...fontsBase,
      width: 336, minHeight: 480, background: "#F5F5F5", borderRadius: 18,
      boxShadow: "0 4px 24px rgba(44,62,80,0.12)", padding: "18px 20px 10px 20px"
    }}>
      <div style={{ textAlign: "center", marginBottom: 8 }}>
        <img src="../../../icons/robo48.png" width={44} style={{ borderRadius: "50%" }} alt="Avatar" />
      </div>
      <div style={headingStyle}>Ê≠°Ëøé‰æÜÂà∞ RoboYouth Taiwan!</div>
      <div style={subheadingStyle}>ÂïèÈ°åÂ∞èÂä©Êâã ‚Ä¢ Error Helper</div>
      <div style={{ ...fontsBase, color: "#2C3E50", fontSize: 13, margin: "14px 0 8px 0" }}>
        Ë´ãÈÅ∏Êìá‰∏ÄÈ†ÖÁóáÁãÄÊàñÂïèÈ°åÁç≤ÂæóÂª∫Ë≠∞Ôºö<br />Select the issue you are facing to get help.
      </div>
      <select
        style={{ ...areaStyle, fontWeight: 500, fontSize: 15 }}
        value={selectedError}
        onChange={handleDropdownChange}
      >
        {dropdownOptions.map(opt =>
          <option key={opt.key} value={opt.key}>{opt.label}</option>
        )}
      </select>
      <div style={{
        ...fontsBase,
        color: "#4A90E2",
        fontWeight: 500,
        margin: "10px 0 4px 2px"
      }}>
        {selectedError && selectedError !== "other" && "üí° Â∏∏Ë¶ãËß£Ê±∫ÊñπÊ°à (Quick Fix Tips):"}
        {selectedError === "other" && "Ë´ãÁî®‰∏ãÊñπAIÂçîÂä©ÂçÄÊèêÂïè"}
      </div>
      <div style={{ color: "#2C3E50", fontSize: 14, minHeight: 62, whiteSpace: "pre-line", marginBottom: 2 }}>
        {output && !loading && <div style={normalMsg}>{output}</div>}
        {loading && <div style={infoMsg}>ÂàÜÊûê‰∏≠‚Ä¶ Processing‚Ä¶</div>}
      </div>
      {renderBlockSummary()}
      <div style={{
        borderTop: "1px solid #E0E0E0", paddingTop: 10, marginTop: 6, marginBottom: 2, fontSize: 13
      }}>
         Ëã•‰∏äËø∞Ëß£Ê±∫ÊñπÊ°àÁÑ°Ê≥ïÂπ´Âä©‰Ω†Ôºö
         <br />If the above doesn't help, please describe your situation and ask the AI:
         <textarea
          placeholder="ÊèèËø∞‰Ω†ÈÅáÂà∞ÁöÑÁãÄÊ≥Å Describe your issue (ÂèØÁî®‰∏≠ÊñáÊàñËã±Êñá)"
          style={{ ...areaStyle, height: 44, resize: "vertical", fontSize: 14 }}
          value={codeSummary}
          onChange={e => setCodeSummary(e.target.value)}
        />
        <button
          style={{ ...secondaryBtn, background: "#fff", color: "#4A90E2", marginTop: 6, border: "1px solid #92BDE7"}}
          onClick={() =>
            chrome.windows.create({
              url: chrome.runtime.getURL("src/popup/index.html"),
              type: "popup",
              width: 380,
              height: 550
            })
          }
        >
          üìå Â∞á AI Â∞èÂä©ÊâãÂõ∫ÂÆöÁÇ∫Ë¶ñÁ™ó<br/>Pin AI Advisor as Window
        </button>
        <button style={secondaryBtn} onClick={handleAskAdvice} disabled={loading || !codeSummary.trim()}>
          ü§ñ ÊèêÂïèAIÔºèAsk AI
        </button>
      </div>
      <div style={{
        fontSize: 11, color: "#8fa6b6", marginTop: 16,
        textAlign: "center", letterSpacing: 0.3
      }}>
        Powered by RoboYouth Taiwan ‚Ä¢ OpenAI<br />
        <span style={{ color: "#92BDE7" }}>
          Support: roboyouthtaiwan@gmail.com
        </span>
      </div>
    </div>
  );
}
